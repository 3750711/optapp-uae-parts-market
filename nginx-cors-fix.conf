# NGINX Configuration for CORS Fix - Edge Functions
# Apply this configuration to your api.partsbay.ae nginx server

location /functions/v1/ {
    proxy_pass https://vfiylfljiixqkjfqubyq.supabase.co/functions/v1/;
    
    # CORS заголовки для всех ответов (включая ошибки)
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'authorization, x-client-info, apikey, content-type' always;
    add_header 'Access-Control-Max-Age' '86400' always;
    
    # Передача критически важных заголовков
    proxy_set_header Authorization $http_authorization;
    proxy_set_header apikey $http_apikey;
    proxy_set_header Content-Type $http_content_type;
    proxy_set_header Host vfiylfljiixqkjfqubyq.supabase.co;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Обеспечение передачи тела запроса
    proxy_pass_request_body on;
    proxy_pass_request_headers on;
    
    # Обработка OPTIONS запросов
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'authorization, x-client-info, apikey, content-type' always;
        add_header 'Access-Control-Max-Age' '86400' always;
        add_header 'Content-Length' '0' always;
        return 204;
    }
}

# Test commands after applying:
# curl -X OPTIONS https://api.partsbay.ae/functions/v1/cloudinary-upload -H "Access-Control-Request-Method: POST" -H "Access-Control-Request-Headers: authorization,apikey,content-type" -v
# curl -X POST https://api.partsbay.ae/functions/v1/cloudinary-upload -H "Authorization: Bearer [token]" -H "apikey: [api-key]" -H "Content-Type: application/json" -d '{"test": "data"}' -v