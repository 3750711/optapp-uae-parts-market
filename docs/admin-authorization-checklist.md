# Чек-лист ревью для админской авторизации

## ✅ Ручная верификация (обязательная проверка)

### 1. Network Tab Проверки
- [ ] В DevTools → Network при переходах по админке **нет** повторных `profiles`/`verify*` запросов
- [ ] При логине админом: ≤1 запрос к `/rest/v1/profiles` 
- [ ] При навигации `/admin` → `/admin/orders` → `/admin/users`: 0 дополнительных `profiles` запросов
- [ ] Отсутствуют 401/refresh циклы при нормальной работе

### 2. PWA и Background Behavior
- [ ] Смена таба/возврат из бэкграунда не вызывает «лавину» вызовов
- [ ] После разворота из фона: ≤1 сетевой запрос максимум  
- [ ] PWA: после разворота состояние таблиц/фильтров **сохраняется**
- [ ] Поиск и сортировка в админ-таблицах сохраняются при возврате

### 3. TTL и кэширование  
- [ ] При TTL-истечении кэша профиля: **ровно 1** фетч профиля
- [ ] Кэш профиля работает корректно (sessionStorage содержит `profile_{userId}` и `profile_{userId}_time`)
- [ ] При TOKEN_REFRESHED профиль **не** перезапрашивается

### 4. Multi-tab синхронизация
- [ ] Разлогин в одной вкладке корректно выкидывает вторую за ≤2 сек
- [ ] Вторая вкладка админки не генерирует дополнительных запросов профиля при открытии
- [ ] BroadcastChannel работает (проверить в консоли логи `📊 Auth Telemetry`)

### 5. Защита от ошибок
- [ ] Нет ошибок `storage quota exceeded` в консоли
- [ ] Нет ошибок `indexedDB blocked` в консоли  
- [ ] Нет ошибок `Failed to fetch` на «сухих» переходах (без реальной необходимости запросов)
- [ ] Админское меню отображается стабильно без «мерцания»

## 🔧 Telemetry Проверки

### Включение телеметрии (Dev Mode)
```javascript
// В консоли браузера:
localStorage.setItem('auth_telemetry_debug', 'true');
```

### Проверка событий
```javascript  
// Посмотреть последние события авторизации:
JSON.parse(localStorage.getItem('auth_telemetry_events') || '[]').slice(-10);

// Экспорт полных данных телеметрии:
window.authTelemetry?.exportTelemetryData();
```

### Критические алерты для отслеживания
- [ ] Нет алертов `profile_fetch_burst` (>1 загрузка профиля за 2 мин)
- [ ] Нет алертов `refresh_cycle_detected` (>3 TOKEN_REFRESHED за 1 мин)  
- [ ] Нет алертов `admin_verify_spam` (>3 проверок админ доступа за 10 сек)

## 🧪 E2E тесты

### Запуск базового набора
```bash
npx playwright test tests/e2e/admin-sessions.spec.ts
```

### Критичные тесты для прохождения
- [ ] **admin-sessions.spec.ts**: "Логин → навигация по админке" - PASS
- [ ] **admin-sessions.spec.ts**: "Token refresh" - PASS  
- [ ] **admin-sessions.spec.ts**: "Мульти-таб" - PASS
- [ ] **admin-sessions.spec.ts**: "TTL-кэш истёк" - PASS
- [ ] **admin-sessions.spec.ts**: "Доступ не-админа" - PASS

## 🎯 Performance Benchmarks

### Timing критерии
- [ ] Логин админа → отображение админской навигации: **≤3 сек**
- [ ] Переход между админскими страницами: **≤1 сек**  
- [ ] Обработка разлогина в мульти-таб: **≤2 сек**
- [ ] Восстановление после возврата из фона: **≤1 сек**

### Memory/Network критерии  
- [ ] Общий размер кэша профиля в sessionStorage: **≤50KB**
- [ ] Количество одновременных запросов при логине: **≤3**
- [ ] Отсутствие memory leaks при длительной работе админки (>30 мин)

## 🚨 Критичные сценарии для обязательного тестирования

### Сценарий 1: Рабочий день админа
1. Логин утром
2. Работа с заказами, пользователями, товарами в течение 2+ часов  
3. Периодические переходы в другие приложения (фон/возврат)
4. Обед (вкладка в фоне 1+ час)
5. Продолжение работы
6. **Критерий**: Нет деградации производительности, стабильная работа

### Сценарий 2: Проблемная сеть
1. Логин с медленным интернетом
2. Кратковременные отключения сети во время работы
3. Переключение между Wi-Fi и мобильным интернетом
4. **Критерий**: Нет потери сессии, корректное восстановление

### Сценарий 3: Мульти-устройство  
1. Логин на рабочем компьютере
2. Логин с мобильного (второе устройство)
3. Работа с обоих устройств одновременно  
4. Разлогин с одного устройства
5. **Критерий**: Синхронизация состояния, нет конфликтов

## 📋 Финальный чек-лист перед продом

- [ ] Все E2E тесты прошли успешно
- [ ] Нет критических алертов в телеметрии  
- [ ] Performance соответствует benchmarks
- [ ] Проведено тестирование критичных сценариев
- [ ] Code review пройден (фокус на single-flight, TTL, BroadcastChannel)
- [ ] Нет TODO/FIXME в критичном коде авторизации
- [ ] Документация обновлена

---

## 🔍 Дополнительные инструменты отладки

### Network Monitor (для E2E тестов)
```typescript
import { NetworkMonitor } from './tests/e2e/helpers/network-monitor';

const monitor = new NetworkMonitor(page);
// Проверки во время теста:
expect(monitor.countProfileRequests(120000)).toBeLessThanOrEqual(1); // за 2 мин
expect(monitor.detectRequestBursts(NetworkMonitor.patterns.PROFILES)).toBe(false);
```

### Auth Context Debug
```javascript
// В консоли для отладки состояния:
window.DEBUG_AUTH = true;

// Принудительная проверка состояния:  
window.authContext?.refreshAdminStatus();
```

### Проверка кэша профиля
```javascript
// Просмотр текущего кэша:
Object.keys(sessionStorage).filter(key => key.startsWith('profile_')).forEach(key => {
  console.log(key, sessionStorage.getItem(key));
});
```