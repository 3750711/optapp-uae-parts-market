import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useToast } from "@/hooks/use-toast";
import { supabase } from "@/integrations/supabase/client";
import { AdminProductFormValues } from "@/schemas/adminProductSchema";
import { extractPublicIdFromUrl } from "@/utils/cloudinaryUtils";
import { useAdminNotifications } from "@/hooks/useAdminNotifications";

interface CreateProductParams {
  values: AdminProductFormValues;
  imageUrls: string[];
  videoUrls: string[];
  primaryImage?: string;
  sellers: Array<{ id: string; full_name: string; opt_id?: string }>;
  brands: Array<{ id: string; name: string }>;
  brandModels: Array<{ id: string; name: string; brand_id: string }>;
}

export const useAdminProductCreation = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [isCreating, setIsCreating] = useState(false);
  const { notifyAdminsNewProduct } = useAdminNotifications();

  const createProductWithTransaction = async ({
    values,
    imageUrls,
    videoUrls,
    primaryImage,
    sellers,
    brands,
    brandModels
  }: CreateProductParams) => {
    if (isCreating) {
      console.warn("Product creation already in progress");
      return;
    }

    setIsCreating(true);
    let productId: string | null = null;
    
    console.log("üöÄ Starting admin product creation transaction:", {
      title: values.title,
      sellerId: values.sellerId,
      imageCount: imageUrls.length,
      videoCount: videoUrls.length,
    });

    try {
      if (imageUrls.length === 0) {
        throw new Error("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é");
      }

      const selectedBrand = brands.find(brand => brand.id === values.brandId);
      const selectedSeller = sellers.find(seller => seller.id === values.sellerId);
      
      if (!selectedBrand) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è");
      if (!selectedSeller) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü");

      let modelName = null;
      if (values.modelId) {
        const selectedModel = brandModels.find(model => model.id === values.modelId);
        modelName = selectedModel?.name || null;
      }

      // --- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è ---

      // 1. –°–æ–∑–¥–∞–µ–º —Ç–æ–≤–∞—Ä
      const { data: product, error: productError } = await supabase
        .from('products')
        .insert({
          title: values.title,
          price: Number(values.price),
          condition: "–ù–æ–≤—ã–π",
          brand: selectedBrand.name,
          model: modelName,
          description: values.description || null,
          seller_id: values.sellerId,
          seller_name: selectedSeller.full_name,
          status: 'pending',
          place_number: Number(values.placeNumber) || 1,
          delivery_price: Number(values.deliveryPrice) || 0,
        })
        .select()
        .single();

      if (productError) {
        throw new Error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: ${productError.message}`);
      }
      productId = product.id;
      console.log("‚úÖ Product created successfully:", productId);

      // 2. –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π)
      const imageInserts = imageUrls.map(url => ({
        product_id: productId,
        url: url,
        is_primary: url === primaryImage
      }));
      const { error: imageError } = await supabase.from('product_images').insert(imageInserts);
      if (imageError) {
        throw new Error(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${imageError.message}`);
      }
      console.log(`‚úÖ ${imageUrls.length} images inserted for product ${productId}`);


      // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä —Å Cloudinary –¥–∞–Ω–Ω—ã–º–∏ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, –±–µ–∑ –æ—Ç–∫–∞—Ç–∞)
      if (primaryImage) {
        try {
          const publicId = extractPublicIdFromUrl(primaryImage);
          if (publicId) {
            await supabase.from('products').update({
                cloudinary_public_id: publicId,
                cloudinary_url: primaryImage
            }).eq('id', product.id);
          }
        } catch (cloudinaryError) {
          console.error("‚ö†Ô∏è Cloudinary processing error (non-critical):", cloudinaryError);
        }
      }

      // 4. –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ (–æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π)
      if (videoUrls.length > 0) {
        const videoInserts = videoUrls.map(videoUrl => ({
          product_id: productId,
          url: videoUrl
        }));
        const { error: videoError } = await supabase.from('product_videos').insert(videoInserts);
        if (videoError) {
          throw new Error(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ: ${videoError.message}`);
        }
        console.log(`‚úÖ ${videoUrls.length} videos inserted for product ${productId}`);
      }

      // 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –Ω–æ–≤–æ–º —Ç–æ–≤–∞—Ä–µ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é
      try {
        await notifyAdminsNewProduct(product.id);
      } catch (adminNotificationError) {
        console.error("‚ö†Ô∏è Admin notification failed (non-critical):", adminNotificationError);
      }

      toast({
        title: "–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω",
        description: `–¢–æ–≤–∞—Ä –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞ ${selectedSeller.full_name} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω.`,
      });

      console.log("‚úÖ Product creation transaction completed successfully:", { productId });
      return product;

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
      console.error("üí• Critical error in product creation transaction:", error);

      // --- –õ–æ–≥–∏–∫–∞ –æ—Ç–∫–∞—Ç–∞ ---
      if (productId) {
        console.log(`üîÑ Rolling back transaction for product ID: ${productId}`);
        // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ storage
        await supabase.from('products').delete().eq('id', productId);
        console.log(`‚úÖ Rollback complete. Product ${productId} deleted.`);
        toast({
          title: "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞",
          description: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä, –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã.",
          variant: "destructive",
        });
      }
      
      toast({
        title: "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞",
        description: errorMessage,
        variant: "destructive",
      });
      
      throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ UI
    } finally {
      setIsCreating(false);
    }
  };

  return {
    createProductWithTransaction,
    isCreating
  };
};
